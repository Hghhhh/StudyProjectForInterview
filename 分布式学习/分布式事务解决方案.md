问题：分布式架构，需要跨多个服务调用，本地事务控制满足不了分布式事务的问题。

解决方案：

- 全局事务
- 柔性事务

## 本地事务

单机上的事务处理

##全局事务

事务由全局事务处理器全局管理

在应用和事务处理器之间有接口，在全局事务处理器和资源管理器（mysql等）之间也有接口，通常采用两阶段提交。

### 两阶段提交

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4.jpg)

###JavaEE平台中的分布式事务实现

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/JavaEE%E5%B9%B3%E5%8F%B0%E4%B8%AD%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0.jpg)

### 利弊

优点：严格的ACID

缺点：效率非常低下

### BASE理论

- BA：Basic Availability基本事务可用性（支持分区失败）

- S：Soft state 柔性状态（状态允许有短时间不同步，异步）
- E：Eventual consistency 最终一致性（最终数据是一致的，但不是实时一致的）

原子性（A）与持久性（D）必须根本保障

为了可用性、性能与降级服务的需要，只有降低一致性（C）和隔离线（I）

酸碱平衡（ACID-BASE Balance）

### CAP定理

C：Consistency(一致性)

A:Availability(可用性)

P:Tolerance to Network Partition(分区容错性)

对于共享数据系统，最多只能同时拥有CAP其中的两个，没法三者兼顾

### 结论

分布式系统中，最重要的是满足业务需求，而不一定是追求严格的ACID特性。



## 柔性事务

### 柔性事务中的服务模式

- 可查询操作：服务操作具有全局唯一标识
- 幂等操作：多次操作和一次操作返回的结果是一样的，f(f(x))=f(x)
- TCC操作:

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/TCC.jpg)

- 可补偿操作

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E5%8F%AF%E8%A1%A5%E5%81%BF%E6%93%8D%E4%BD%9C.jpg)

### 柔性事务解决方案：可靠消息最终一致（异步确保型）

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4.jpg)

- 用到的服务模式：可查询操作、幂等操作
- 案例：微信支付的时候异步发送支付结果

### 柔性事务解决方案：TCC（两阶段、补偿型）

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/TCC2.jpg)

- 用到的模式：TCC模式、可查询操作、可补偿操作、幂等操作
- 案例：支付宝XTS

### 柔性事务解决方案：最大努力通知（定期校对）

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5.jpg)

- 用到的服务模式：可查询操作
- 案例：银行通知、商户通知

## 消息发送一致性

在分布式系统中引入消息中间件，实现异步通讯、解耦、并发缓存

但是分布式部署环境下，需要通过网络进行通讯，就引入了数据传输的不确定性也就是CAP理论中的P（分区容错性的问题）

**消息发送一致性**就是指产生消息的业务动作与消息发送的一致。（也就是说如果业务操作成功，那由这个业务操作所产生的消息一定要成功投递出去，否则就丢消息）

### JMS标准中的XA协议方式是否可以保障发送一致性？

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/JMS%E4%BF%9D%E9%9A%9C%E5%8F%91%E9%80%81%E4%B8%80%E8%87%B4%E6%80%A7.jpg)

### 消息发送一致性：变通性的做法

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E5%8F%98%E9%80%9A%E7%9A%84%E5%81%9A%E6%B3%95.jpg)

发生故障的处理方法

