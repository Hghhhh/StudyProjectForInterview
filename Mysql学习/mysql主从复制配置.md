#主从复制

## 1.什么是主从复制

为了做mysql数据库集群，我们需要先保证每台数据库里面的数据同步，主从复制需要两台以上的数据库，至少有一台主数据库，和一台从数据库，从数据库是和主数据库完全一样的数据库环境，主数据库一般是准实时的业务数据库。

##2.主从复制的好处、作用
（1）做数据的热备，作为后备数据库，主数据库服务器故障后，可切换到从数据库继续工作，避免数据丢失。

（2）架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的频率，提高单个机器的I/O性能。

（3）读写分离，使数据库能支撑更大的并发。在报表中尤其重要。由于部分报表sql语句非常的慢，导致锁表，影响前台服务。如果前台使用master，报表使用slave，那么报表sql将不会造成前台锁，保证了前台速度。

如何配置：[这篇文章](http://www.cnblogs.com/phpstudy2015-6/p/6485819.html#_label7)

##3.主从复制的原理

（1）主服务器凡运行语句,都产生一个二进制日志 binlog

（2）从服务器不断读取主服务器的binlog

（3）从主服务读取到的binlog,转换为自身可执行的relaylog,

（4）执行relaylog

（5）具体需要三个线程来操作：
1.binlog输出线程（dump thread）:每当有从库连接到主库的时候，主库都会创建一个线程然后发送binlog内容到从库。

在从库里，当复制开始的时候，从库就会创建两个线程进行处理：

2.从库I/O线程(I/O thread):当START SLAVE语句在从库开始执行之后，从库创建一个I/O线程，该线程连接到主库并请求主库发送binlog里面的更新记录到从库上。从库I/O线程读取主库的binlog输出线程发送的更新并拷贝这些更新到本地文件，其中包括relay log文件。

3.从库的SQL线程（sql thread）:从库创建一个SQL线程，这个线程读取从库I/O线程写到relay log的更新事件并执行。

原理图：

![](https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86.png)

##4.从数据库的读延迟问题如何解决？

解决方法：并行复制

复制出现延迟一般出在两个地方

1）SQL线程忙不过来（可能需要应用数据量较大，可能和从库本身的一些操作有锁和资源的冲突；主库可以并发写，SQL线程不可以；主要原因）

2）网络抖动导致IO线程复制延迟（次要原因）。

在MySQL 5.7中，引入了基于组提交的并行复制（Enhanced Multi-threaded Slaves），设置参数slave_parallel_workers>0并且global.slave_parallel_type＝‘LOGICAL_CLOCK’，即可支持一个组下，slave_parallel_workers个的worker线程并发执行relay log中主库提交的事务。其核心思想：一个组提交的事务都是可以并行回放（配合binary log group commit）；

https://www.cnblogs.com/xiaotengyi/p/5532191.html



##5.做主从后主服务器挂了怎么办？

主服务器挂了，使用从数据库代替为主库，但是可能会出现从数据库中的数据因为主数据库还没传过来就挂掉了，而缺失某些数据的问题。

解决方法：半同步复制

介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。

mysql5.7的loss-less模式，在收到从服务器的ack后才提交事务，保证了从服务器收到了binlog并写到relaylog中，无数据丢失。同时mysql5.7还对dump thread进行了优化，分成两个thread，多了一个ack collector线程来负责收集ack。

https://www.cnblogs.com/ivictor/p/5735580.html

